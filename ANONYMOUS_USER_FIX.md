# Fixed the issue of saving history of unlogged users

## Problem Description

Image records generated by unlogged in users cannot be saved to Supabase database, resulting in:
1. Users who are not logged in cannot view history
2. Administrators cannot see data from anonymous users
3. Data statistics are incomplete

## root cause

1. **Database Constraint**: The `user_id` field of the `history` table is set to `NOT NULL`
2. **Front-end logic**: Users who are not logged in skip the backend save directly
3. **API Verification**: Requirements must have `user_id` parameter

## Repair steps

### 1. Database Repair

Run `fix-anonymous-user-history.sql` in Supabase SQL Editor:

````sql
-- Modify the user_id field to allow NULL values
ALTER TABLE public.history
ALTER COLUMN user_id DROP NOT NULL;

-- Update RLS policy
DROP POLICY IF EXISTS "Allow anonymous access to history" ON public.history;
CREATE POLICY "Allow anonymous access to history" ON public.history
    FOR ALL USING (true);

-- Create index optimization query
CREATE INDEX IF NOT EXISTS idx_history_user_id_null ON public.history(user_id) WHERE user_id IS NULL;
CREATE INDEX IF NOT EXISTS idx_history_user_id_not_null ON public.history(user_id) WHERE user_id IS NOT NULL;
```

### 2. Add a new API endpoint

#### Save anonymous user history
- File: `/api/save-anonymous-history.js`
- Function: Allows `user_id` to insert records for `NULL`

#### Get anonymous user history
- File: `/api/get-anonymous-history.js`
- Function: Query records with `user_id` as `NULL`

### 3. Front-end code repair

The following functions in `index.html` need to be modified:

#### Modify the `saveHistoryToSupabase` function
```javascript
async function saveHistoryToSupabase(historyItem) {
    if (!config) {
        console.log('Configuration not loaded, history synchronization skipped');
        return false;
    }
    
    try {
        let response;
        
        if (currentUser) {
            // Logged in users use the original API
            response = await fetch('/api/user-history-unified', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'user-id': currentUser.id
                },
                body: JSON.stringify({
                    type: historyItem.type,
                    prompt: historyItem.prompt,
                    result_image: historyItem.resultImage,
                    input_images: historyItem.inputImages,
                    user_id: currentUser.id
                })
            });
        } else {
            //Unlogged in user uses new anonymous API
            response = await fetch('/api/save-anonymous-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: historyItem.type,
                    prompt: historyItem.prompt,
                    result_image: historyItem.resultImage,
                    input_images: historyItem.inputImages
                })
            });
        }
        
        const result = await response.json();
        
        if (!response.ok) {
            console.error('Failed to save history:', result.error);
            return false;
        }
        
        return result.data && result.data[0] ? result.data[0] : false;
        
    } catch (error) {
        console.error('History save error:', error);
        return false;
    }
}
```

#### Modify the `loadUserHistory` function
```javascript
async function loadUserHistory() {
    if (!config) {
        console.log('Configuration not loaded, history loading skipped');
        return;
    }
    
    try {
        let response;
        
        if (currentUser) {
            //Load personal history by logged in
            response = await fetch(`/api/user-history-unified?user_id=${currentUser.id}&simple=true`, {
                method: 'GET',
                headers: {
                    'user-id': currentUser.id
                }
            });
        } else {
            //Unlogged user loads anonymous history
            response = await fetch('/api/get-anonymous-history?simple=true', {
                method: 'GET'
            });
        }
        
        const result = await response.json();
        
        if (!response.ok) {
            console.error('Loading history failed:', result.error);
            return;
        }
        
        if (result.data && Array.isArray(result.data)) {
            userHistory = result.data.map(item => ({
                id: item.id,
                type: item.type,
                prompt: item.prompt,
                resultImage: item.result_image,
                inputImages: item.input_images,
                createdAt: item.created_at,
                userInfo: {
                    name: item.user_name || 'Anonymous User',
                    email: item.user_email || 'Not logged in',
                    avatar: item.user_avatar || null
                }
            }));
            
            console.log('History loaded successfully, quantity:', userHistory.length);
            renderHistory();
        }
        
    } catch (error) {
        console.error('Load history error:', error);
    }
}
```

#### Modify page initialization logic
```javascript
async function initializePage() {
    console.log('=== page initialization start ===');
    
    try {
        // Load configuration
        await loadConfig();
        
        // Initialize Supabase
        await initializeSupabase();
        
        // Check whether there is saved user information
        const savedUser = localStorage.getItem('nanoBananaUser');
        if (savedUser) {
            try {
                const user = JSON.parse(savedUser);
                currentUser = user;
                console.log('Recover user information from localStorage:', user.id);
                
                // Update UI display
                updateLoginUI();
                
                // Show history main tab page
                document.getElementById('history-main-tab').style.display = 'inline-block';
                
                // Load user history
                await loadUserHistory();
            } catch (error) {
                console.error('Recovering user information failed:', error);
                localStorage.removeItem('nanoBananaUser');
            }
        } else {
            // The unlogged user also loads anonymous history
            console.log('User not logged in, anonymous history is loaded');
            await loadUserHistory();
        }
        
        console.log('=== Page initialization is completed ===');
        
    } catch (error) {
        console.error('Page initialization failed:', error);
    }
}
```

### 4. Deploy new files

Deploy the following files to the server:
- `api/save-anonymous-history.js`
- `api/get-anonymous-history.js`

### 5. Test verification

1. **Unlogged in user test**:
   - Generate an image
   - Check whether the history is displayed
   - Refresh the page and check whether the history is maintained

2. **Administrator background test**:
   - Visit `/admin.html`
   - Check whether anonymous user records can be seen
   - Test filtering function

3. **Database Verification**:
   ````sql
   -- View anonymous user records
   SELECT * FROM history WHERE user_id IS NULL ORDER BY created_at DESC LIMIT 10;
   
   -- Statistics the number of records
   SELECT
       COUNT(*) as total,
       COUNT(CASE WHEN user_id IS NULL THEN 1 END) as anonymous,
       COUNT(CASE WHEN user_id IS NOT NULL THEN 1 END) as logged_in
   FROM history;
   ```

## Expected results

After repair:
1. ✅ Unlogged in users can save and view history
2. ✅ Administrators can see data from all users (including anonymous)
3. ✅ Data statistics include anonymous users
4. ✅ You can continue to use after logging in, and the history will not be lost.

## Notes

1. **Data Privacy**: Anonymous user records do not contain personal information
2. **Storage Limits**: Anonymous user records may take up more storage space
3. **Cleaning Policy**: It is recommended to regularly clean out expired anonymous user records
4. **Performance Impact**: Need to add an index for `user_id` to `NULL` query

## Rollback plan

If there is a problem after fixing, you can roll back:

````sql
-- Recover NOT NULL constraints
ALTER TABLE public.history
ALTER COLUMN user_id SET NOT NULL;

-- Delete anonymous user records
DELETE FROM public.history WHERE user_id IS NULL;
```